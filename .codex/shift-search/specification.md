# NAZOMATIC シフト検索 仕様書

作成日: 2026-02-24  
対象リポジトリ: `c:\Users\119003\git\nazomatic`

---

## 1. 目的

- 入力単語を文字シフトして辞書照合する「シフト検索」を追加する。
- 既存 `/anagram` には統合せず、**新しい独立ページ**として実装する。
- 既存の辞書資産（`SearchManager`, `public/dic/*.dic`）は再利用する。

---

## 2. ルーティング / 画面構成

- 新規ページ:
  - パス: `/shift-search`
  - 実装想定: `src/app/(main)/shift-search/page.tsx`
- 新規UIコンポーネント:
  - 実装想定: `src/components/shift-search/shift-search.tsx`
- ナビゲーション掲載:
  - `src/lib/json/features.json` に `/shift-search` を追加する。
- 非変更:
  - `/anagram`（既存のアナグラム/クロスワード/正規表現検索）は既存仕様のまま維持する。

---

## 3. 入力・辞書

- 辞書は既存の `DICTIONARIES` を利用する（`buta`, `cefr` など）。
- 辞書タイプに応じてシフト範囲を切り替える。
  - 英語: 1..25
  - 日本語: 1..45
- 入力は 1 単語想定。空入力はエラー。

---

## 4. シフト仕様

## 4.1 英語

- 文字集合: `abcdefghijklmnopqrstuvwxyz`
- 各文字を巡回シフトする（`z + 1 => a`）。
- 大文字入力は小文字に正規化して処理する。

## 4.2 日本語（ひらがな）

- シフト対象の基本文字集合（46）:
  - `あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん`

### 小文字の扱い

- 小書き文字はシフト前に通常文字へ正規化する（無視して大文字扱い）。
- 例:
  - `ぁ=>あ`, `ぃ=>い`, `ぅ=>う`, `ぇ=>え`, `ぉ=>お`
  - `ゃ=>や`, `ゅ=>ゆ`, `ょ=>よ`, `っ=>つ`, `ゎ=>わ`

### 濁点・半濁点の扱い

- 濁点・半濁点は**保持したまま検索**する（濁点を外して別扱いにしない）。
- 処理手順:
  1. 入力文字を「ベース文字 + 修飾種別（なし / 濁点 / 半濁点）」に分解
  2. ベース文字のみ 46 文字集合でシフト
  3. シフト後ベース文字に同じ修飾種別を再付与
  4. 再付与不能な文字の場合は修飾を外した文字を採用
- 仕様例:
  - `ど` は `と(濁点)` として扱う
  - `と` を +1 すると `な`
  - `な` に濁点は付与できないため、結果は `な`
- 要件:
  - 濁点/半濁点が付与可能なシフト先では、必ず付与した結果を返す。

---

## 5. 検索仕様

- 各 `shift` ごとに「シフト後文字列」を生成し、辞書を検索する。
- 検索モード:
  - `完全一致`（常時実行）
  - `ずらした後でアナグラム検索`（チェックON時のみ）
- アナグラム検索は既存 `findAnagramsAsync` を利用可能。
- 結果項目:
  - `resultWord`
  - `shift`
  - `matchType`（`exact` / `anagram`）
  - `sourceWord`（その結果の元になったシフト後文字列）
- 並び順:
  - `shift` 昇順 → `matchType`（exact優先）→ `resultWord` 昇順
- 重複除去:
  - `resultWord + shift + matchType` が同一なら1件に統合

---

## 6. パフォーマンス制約

- **`ANAGRAM_RESULT_MAXCOUNT` とは分離**して、シフト検索専用上限を定義する。
- シフト検索専用上限（初期値案）:
  - `SHIFT_EXACT_RESULT_MAXCOUNT = 1000`
  - `SHIFT_ANAGRAM_RESULT_MAXCOUNT = 3000`
  - `SHIFT_TOTAL_RESULT_MAXCOUNT = 5000`
- 方針:
  - シフト検索は既存アナグラムより多く結果を扱えるようにする。
  - 上限はシフト検索ページ内の定数で個別管理し、将来設定変更しやすくする。

---

## 7. UI仕様

- 画面要素:
  - 入力欄
  - 辞書選択
  - チェックボックス: `ずらした後でアナグラム検索を有効にする`
  - 検索ボタン
  - 結果一覧
- 結果表示例:
  - `な (shift +1, exact)`
  - `tone (shift +3, anagram)`
- 1行に「単語」「shift値」「一致種別」が分かる表示にする。

---

## 8. 受け入れ基準

1. `/shift-search` が新規ページとして動作し、`/anagram` は既存機能のまま動作する。
2. 英語辞書では `1..25`、日本語辞書では `1..45` を必ず探索する。
3. 検索結果に shift 値が表示される。
4. アナグラムオプションONで `anagram` 結果が追加表示される。
5. シフト検索は `ANAGRAM_RESULT_MAXCOUNT` と独立した上限で動作する。
6. 日本語の濁点・半濁点は保持して処理される。
7. 濁点/半濁点の再付与が不可能なシフト先では、修飾なし文字で結果化される（例: `ど +1 => な`）。
8. 日本語小文字（`っゃ` 等）は大文字扱いで処理される。

---

## 9. 実装ステップ（推奨）

1. `/shift-search` ページと `ShiftSearch` コンポーネントを追加
2. ひらがな正規化（小文字→大文字、濁点/半濁点分解・再付与）ユーティリティを追加
3. シフト検索ロジック（英語/日本語）を実装
4. 完全一致 + オプションアナグラム検索の統合
5. シフト検索専用の結果上限定数を実装
6. `features.json` 追加と回帰確認（`/anagram` 非破壊）

