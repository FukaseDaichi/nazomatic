name: Realtime Prune

on:
  workflow_dispatch:
  schedule:
    - cron: "15 0 * * *" # Daily at 00:15 UTC

jobs:
  trigger-prune:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Invoke realtime prune API
        env:
          BASE_URL: ${{ secrets.REALTIME_API_BASE_URL }}
          API_TOKEN: ${{ secrets.REALTIME_API_TOKEN }}
        run: |
          if [ -z "$BASE_URL" ] || [ -z "$API_TOKEN" ]; then
            echo "Missing required secrets REALTIME_API_BASE_URL or REALTIME_API_TOKEN."
            exit 1
          fi

          curl --fail --silent --show-error \
            --retry 3 --retry-delay 10 \
            -X POST "$BASE_URL/api/internal/realtime/prune" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"cutoffDays":1,"dryRun":false}'
